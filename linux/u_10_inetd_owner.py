import subprocess
import utils.auth_counter

XINETD_PATH = "/etc/xinetd.d/*"

def check_ownership():
    inetd = subprocess.run("ls -l /etc/inetd.conf",shell = True, capture_output = True, text = True).stdout
    xinetd = subprocess.run("ls -l /etc/xinetd.conf",shell = True, capture_output = True, text = True).stdout
    
    if inetd == "" and xinetd == "":
        print("[N/A] /etc/(x)inetd.conf 파일 소유자 및 권한 설정 ")
    
    inetd_auth_num = 1000
    xinetd_auth_num = 1000
    
    if inetd != "":
        inetd_auth_num = utils.auth_counter.main(inetd.split(" ")[0])
    if xinetd != "":
        xinetd_auth_num = utils.auth_counter.main(xinetd.split(" ")[0])
    
    if xinetd_auth_num <= 600 and xinetd.split(" ")[2] == "root":
        read_dir()
        return
    elif inetd_auth_num <= 600 in inetd and inetd.split(" ")[2] == "root":
        print("[양호] /etc/(x)inetd.conf 파일 소유자 및 권한 설정 ")
    else:
        print("[취약] /etc/(x)inetd.conf 파일 소유자 및 권한 설정 ")


def read_dir():
    total_result = True
    try:
        with open(XINETD_PATH, 'r') as file:
            for line in file:
                if line.split(" ")[0] != "rw-------" or line.split(" ")[2] != "root":
                    print(f"       파일 소유자 및 권한 설정 필요 : {line}")
                    total_result = False
            if total_result == True:
                print("[양호] /etc/(x)inetd.conf 파일 소유자 및 권한 설정 ")
            else:
                print("[취약] /etc/(x)inetd.conf 파일 소유자 및 권한 설정 ")
                
                    
    except FileNotFoundError:
        print(f"       파일이 존재하지 않습니다: {file_path}")
    except Exception as e:
        print(f"       파일을 읽는 중 오류 발생: {e}")

def main():
    print("")
    print("======================= U-10 /etc/(x)inetd.conf 파일 소유자 및 권한 설정 =========================")
    check_ownership()