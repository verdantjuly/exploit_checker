import sys
import io
from datetime import datetime
import os
import linux.script
import platform

DIRECTORY_PATH = "result"  # 상대 경로로 변경

def directory_creator(directory_path):
    if not os.path.exists(directory_path):
        try:
            os.makedirs(directory_path)
            print(f"폴더 '{directory_path}'를 생성했습니다.")
        except Exception as e:
            print(f"폴더를 생성하는 중 오류 발생: {e}")

class DualWriter(io.StringIO):
    def __init__(self, file):
        super().__init__()
        self.file = file
        self.file_open = True

    def write(self, s):
        super().write(s)
        if self.file_open:
            self.file.write(s)

    def close(self):
        self.file_open = False
        super().close()

def ask_user_for_logging():
    while True:
        response = input("콘솔 출력을 파일로 저장하시겠습니까? (y/n): ").strip().lower()
        if response in ('y', 'n'):
            return response == 'y'
        else:
            print("잘못된 입력입니다. 'y' 또는 'n'을 입력해주세요.")



def run_script(save_to_file):
    if save_to_file:
        now = datetime.now()
        timestamp = now.strftime("%Y%m%d_%H%M%S")
        filename = os.path.join(DIRECTORY_PATH, f'result_{timestamp}.txt')

        with open(filename, 'w') as file:
            dual_writer = DualWriter(file)
            sys.stdout = dual_writer
            os_type = platform.system()
            try:
                script(os_type)
            finally:
                sys.stdout = sys.__stdout__
                dual_writer.close()

        with open(filename, 'r') as file:
            print(file.read())
            print("=======================================================================")
            print("")
            print(f"{DIRECTORY_PATH} 디렉토리에 {filename}가 저장되었습니다.")
            print("")

    else:
        try:
            script(os_type)
        except Exception as e:
            print(f"스크립트 실행 중 오류 발생: {e}")


def script(os_type):
    match os_type:
        case "Linux":
            linux.script.main()


if __name__ == "__main__":
    directory_creator(DIRECTORY_PATH)
    save_to_file = ask_user_for_logging()
    run_script(save_to_file)
